<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Purchasing Power – Call Dashboard v3</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --surface2: #243044;
      --text: #e6edf3;
      --text-muted: #8b9cb3;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --success: #22c55e;
      --warning: #eab308;
      --border: #2d3a4d;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .header h1 {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .header .load-area {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .file-input-wrap {
      position: relative;
    }
    .file-input-wrap input[type="file"] {
      position: absolute;
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      z-index: -1;
    }
    .file-input-wrap label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #fff;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .file-input-wrap label:hover { filter: brightness(1.1); }
    .file-name { color: var(--text-muted); font-size: 0.85rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .container { max-width: 1600px; margin: 0 auto; padding: 1.5rem; }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .kpi-section { margin-bottom: 1.5rem; }
    .kpi-section-title { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.5rem; }
    .kpi-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
    }
    .kpi-card .label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.25rem; }
    .kpi-card .value { font-size: 1.5rem; font-weight: 700; }
    .kpi-card .sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    @media (max-width: 1000px) { .charts-grid { grid-template-columns: 1fr; } }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      min-height: 320px;
    }
    .chart-card h3 { margin: 0 0 1rem; font-size: 1rem; font-weight: 600; color: var(--text); }
    .chart-card.grid-column-full { grid-column: 1 / -1; }
    .chart-wrap { position: relative; height: 280px; }
    .chart-wrap-sm { height: 240px; }
    .endstate-by-outcome { margin-bottom: 1.5rem; grid-column: 1 / -1; }
    .endstate-by-outcome-title { font-size: 1rem; font-weight: 600; color: var(--text); margin: 0 0 0.75rem; }
    .endstate-by-outcome-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    @media (max-width: 1100px) { .endstate-by-outcome-grid { grid-template-columns: 1fr; } }
    .overlap-1047a-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; }
    .overlap-1047a-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem 1rem; }
    .overlap-1047a-card .label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .overlap-1047a-card .value { font-size: 1.25rem; font-weight: 700; }
    .wismo-summary { margin-bottom: 1rem; }
    #wismoCard { min-height: 120px; }
    .wismo-summary .kpi-card { display: inline-block; margin-right: 1rem; margin-bottom: 0.5rem; }
    .wismo-path-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .wismo-path-table th, .wismo-path-table td { text-align: left; padding: 0.4rem 0.75rem; border-bottom: 1px solid var(--border); }
    .wismo-path-table th { color: var(--text-muted); font-weight: 600; }
    .wismo-path-table td:last-child { text-align: right; font-variant-numeric: tabular-nums; }
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-muted);
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
    }
    .empty-state p { margin: 0 0 1rem; }
    .loading { color: var(--accent); }
    .error { color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem; }
    .date-range-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      flex-wrap: wrap;
    }
    .date-range-bar label { font-size: 0.85rem; color: var(--text-muted); }
    .date-range-bar input[type="date"] {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 0.4rem 0.6rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Purchasing Power – Call Dashboard <span style="font-size:0.6em; font-weight:normal; opacity:0.8;">v3</span></h1>
    <div class="load-area">
      <div class="file-input-wrap">
        <input type="file" id="csvFile" accept=".csv" />
        <label for="csvFile">Load CSV</label>
      </div>
      <span class="file-name" id="fileName">No file selected</span>
    </div>
  </header>
  <main class="container">
    <div id="emptyState" class="empty-state">
      <p><strong id="versionBadge">Dashboard v3</strong> — Load <strong>Purchasing Power January 2026.csv</strong> (or any CSV with the same columns) to view the dashboard.</p>
      <p class="error" id="loadError"></p>
    </div>
    <div id="dashboard" style="display: none;">
      <div class="date-range-bar">
        <label for="dateFrom">From</label>
        <input type="date" id="dateFrom" />
        <label for="dateTo">To</label>
        <input type="date" id="dateTo" />
      </div>
      <div class="kpi-grid" id="kpiGrid"></div>
      <div class="kpi-section">
        <div class="kpi-section-title">Authentication (breadcrumb 1005a)</div>
        <div class="kpi-grid" id="authKpiGrid"></div>
      </div>
      <div class="charts-grid">
        <div class="chart-card"><h3>Outcome distribution</h3><div class="chart-wrap"><canvas id="chartOutcome"></canvas></div></div>
        <div class="chart-card"><h3>Calls by date</h3><div class="chart-wrap"><canvas id="chartByDate"></canvas></div></div>
        <div class="endstate-by-outcome">
          <h3 class="endstate-by-outcome-title">Top 10 end states by outcome</h3>
          <div class="endstate-by-outcome-grid">
            <div class="chart-card"><h3>Finish — Top 10 end states</h3><div class="chart-wrap chart-wrap-sm"><canvas id="chartEndStateFinish"></canvas></div></div>
            <div class="chart-card"><h3>FinishXfer — Top 10 end states</h3><div class="chart-wrap chart-wrap-sm"><canvas id="chartEndStateFinishXfer"></canvas></div></div>
            <div class="chart-card"><h3>BizRuleXfer — Top 10 end states</h3><div class="chart-wrap chart-wrap-sm"><canvas id="chartEndStateBizruleXfer"></canvas></div></div>
          </div>
        </div>
        <div class="chart-card grid-column-full" id="wismoCard">
          <h3>WisMO calls — Entry and paths</h3>
          <div class="wismo-summary" id="wismoSummary"></div>
          <div id="wismoPathTableWrap"></div>
        </div>
        <div class="chart-card"><h3>Caller intent (breadcrumb)</h3><div class="chart-wrap"><canvas id="chartIntent"></canvas></div></div>
        <div class="chart-card"><h3>VA duration (minutes) distribution</h3><div class="chart-wrap"><canvas id="chartDuration"></canvas></div></div>
        <div class="chart-card grid-column-full">
          <h3>Callers who reached 1047a and also had intent</h3>
          <div class="overlap-1047a-grid" id="overlap1047aGrid"></div>
        </div>
        <div class="chart-card"><h3>Top employers by call volume (top 10)</h3><div class="chart-wrap"><canvas id="chartEmployer"></canvas></div></div>
      </div>
    </div>
  </main>
  <script>
    (function () {
      const csvFile = document.getElementById('csvFile');
      const fileName = document.getElementById('fileName');
      const emptyState = document.getElementById('emptyState');
      const dashboard = document.getElementById('dashboard');
      const loadError = document.getElementById('loadError');
      const kpiGrid = document.getElementById('kpiGrid');
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');

      let charts = {};
      let allRows = [];

      function hideError() { loadError.textContent = ''; }
      function showError(msg) { loadError.textContent = msg; }

      function parseCSV(file) {
        return new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: false,
            complete: function (res) {
              if (res.errors.length && !res.data.length) reject(new Error(res.errors[0].message || 'Parse error'));
              else resolve(res.data);
            }
          });
        });
      }

      const INTENT_BREADCRUMBS = {
        'WisMO': '1011c',
        'Returns': '1011b',
        'Password reset': '1011d',
        'Account balance': '1024a',
        'Spending limit': '1024b',
        'Changing contact info': '1011f'
      };
      const INTENT_BREADCRUMBS_FOR_1047A = [
        { label: 'Returns (1045a)', code: '1045a' },
        { label: 'WisMO (1045c)', code: '1045c' },
        { label: 'Password Reset (1045d)', code: '1045d' },
        { label: 'Account Balance (1024a)', code: '1024a' },
        { label: 'Change Contact Information (1024b)', code: '1024b' }
      ];
      const AUTH_BREADCRUMB = '1005a';
      const BREADCRUMB_1047A = '1047a';
      const WISMO_ENTRY_BREADCRUMB = '1011c';
      const WISMO_PATH_GROUPS = [
        { name: 'Order Selection', codes: ['1018a', '1059a', '1059b', '1059c', '1059d'] },
        { name: 'Order Status', codes: ['1015b', '1015c', '1015f', '1015h', '1020b'] },
        { name: 'Order Tracked', codes: ['1015e', '1061a', '1061b'] },
        { name: 'Order Placed', codes: ['1015g'] },
        { name: 'Order Details', codes: ['1060a', '1060b'] },
        { name: 'No Order Selected', codes: ['1020a', '1021a'] },
        { name: 'Hot Word / Exit', codes: ['1021b'] },
        { name: 'Other / No Order Found', codes: ['1015a', '1015i'] },
        { name: 'Summary', codes: ['1017a', '1017b'] },
        { name: 'Other Path', codes: ['1015d'] }
      ];
      const WISMO_PATH_CODES_SET = new Set(WISMO_PATH_GROUPS.flatMap(g => g.codes));

      function getBreadcrumbParts(r) {
        return (r.Breadcrumb || '').split(',').map(s => s.trim()).filter(Boolean);
      }

      function getRowDate(r) {
        const dt = (r.DateTimeET || '').trim();
        return dt ? dt.split(' ')[0] : '';
      }

      function filterRowsByDateRange(rows, fromVal, toVal) {
        if (!fromVal && !toVal) return rows;
        return rows.filter(r => {
          const d = getRowDate(r);
          if (!d) return false;
          if (fromVal && d < fromVal) return false;
          if (toVal && d > toVal) return false;
          return true;
        });
      }

      function applyDateRange() {
        if (!allRows.length) return;
        const fromVal = dateFrom.value || '';
        const toVal = dateTo.value || '';
        const filtered = filterRowsByDateRange(allRows, fromVal, toVal);
        const agg = aggregate(filtered);
        renderKPIs(agg);
        renderCharts(agg);
      }

      const OUTCOME_ENDSTATE_KEYS = ['finish', 'finishXfer', 'bizruleXfer'];

      function aggregate(rows) {
        const byOutcome = {};
        const byEndState = {};
        const byOutcomeAndEndState = { finish: {}, finishXfer: {}, bizruleXfer: {} };
        const byDate = {};
        const byEmployer = {};
        const byCallCenter = {};
        const vaDurations = [];
        let withTransfer = 0;
        let totalXferSec = 0;
        let authenticatedCount = 0;
        const byIntent = { 'WisMO': 0, 'Returns': 0, 'Password reset': 0, 'Account balance': 0, 'Spending limit': 0, 'Changing contact info': 0 };
        const by1047aAndIntent = {};
        INTENT_BREADCRUMBS_FOR_1047A.forEach(({ label }) => { by1047aAndIntent[label] = 0; });
        let wismoEnteredCount = 0;
        const byWismoPath = {};
        const byWismoPathGroup = {};
        WISMO_PATH_GROUPS.forEach(g => { byWismoPathGroup[g.name] = 0; });

        rows.forEach(r => {
          const outcome = (r.Outcome || '').trim() || 'Unknown';
          byOutcome[outcome] = (byOutcome[outcome] || 0) + 1;

          const endState = (r.EndState || '').trim();
          if (endState && endState !== '(none)' && endState.toLowerCase() !== 'none') {
            byEndState[endState] = (byEndState[endState] || 0) + 1;
            if (byOutcomeAndEndState[outcome]) {
              byOutcomeAndEndState[outcome][endState] = (byOutcomeAndEndState[outcome][endState] || 0) + 1;
            }
          }

          const dt = (r.DateTimeET || '').trim();
          const date = dt ? dt.split(' ')[0] : '';
          if (date) byDate[date] = (byDate[date] || 0) + 1;

          const emp = (r.EmployerName || '').trim();
          if (emp && emp !== '(none)' && emp.toLowerCase() !== 'none') byEmployer[emp] = (byEmployer[emp] || 0) + 1;

          const cc = (r.CallCenter || '').trim() || '(none)';
          byCallCenter[cc] = (byCallCenter[cc] || 0) + 1;

          const vaMin = parseInt(r.VAmin, 10) || 0;
          const vaSec = parseInt(r.VAsec, 10) || 0;
          vaDurations.push(vaMin + vaSec / 60);

          const xferSec = parseInt(r.Xfersec, 10) || 0;
          if (xferSec > 0) { withTransfer++; totalXferSec += xferSec; }

          const parts = getBreadcrumbParts(r);
          if (parts.includes(AUTH_BREADCRUMB)) authenticatedCount++;
          Object.entries(INTENT_BREADCRUMBS).forEach(([label, code]) => {
            if (parts.includes(code)) byIntent[label]++;
          });
          if (parts.includes(BREADCRUMB_1047A)) {
            INTENT_BREADCRUMBS_FOR_1047A.forEach(({ label, code }) => {
              if (parts.includes(code)) by1047aAndIntent[label]++;
            });
          }
          if (parts.includes(WISMO_ENTRY_BREADCRUMB)) {
            wismoEnteredCount++;
            parts.forEach(code => {
              if (code === WISMO_ENTRY_BREADCRUMB) return;
              if (WISMO_PATH_CODES_SET.has(code)) byWismoPath[code] = (byWismoPath[code] || 0) + 1;
            });
            WISMO_PATH_GROUPS.forEach(g => {
              if (g.codes.some(c => parts.includes(c))) byWismoPathGroup[g.name]++;
            });
          }
        });

        return {
          total: rows.length,
          authenticatedCount,
          byIntent,
          by1047aAndIntent,
          wismoEnteredCount,
          byWismoPath,
          byWismoPathGroup,
          byOutcome,
          byEndState,
          byOutcomeAndEndState,
          byDate,
          byEmployer,
          byCallCenter,
          vaDurations,
          withTransfer,
          totalXferSec
        };
      }

      function renderKPIs(agg) {
        const finish = agg.byOutcome.finish || 0;
        const finishXfer = agg.byOutcome.finishXfer || 0;
        const bizruleXfer = agg.byOutcome.bizruleXfer || 0;
        const agentRequests = (agg.byOutcome.callerXfer1 || 0) + (agg.byOutcome.callerXfer2 || 0);
        const total = agg.total;
        const authenticated = agg.authenticatedCount || 0;
        const nonAuthenticated = total - authenticated;

        kpiGrid.innerHTML = `
          <div class="kpi-card"><div class="label">Total calls</div><div class="value">${total.toLocaleString()}</div></div>
          <div class="kpi-card"><div class="label">Finish calls</div><div class="value">${finish.toLocaleString()}</div><div class="sub">${total ? (100 * finish / total).toFixed(1) : 0}%</div></div>
          <div class="kpi-card"><div class="label">Finish transfers</div><div class="value">${finishXfer.toLocaleString()}</div><div class="sub">${total ? (100 * finishXfer / total).toFixed(1) : 0}%</div></div>
          <div class="kpi-card"><div class="label">Bizrule transfers</div><div class="value">${bizruleXfer.toLocaleString()}</div><div class="sub">${total ? (100 * bizruleXfer / total).toFixed(1) : 0}%</div></div>
          <div class="kpi-card"><div class="label">Agent requests</div><div class="value">${agentRequests.toLocaleString()}</div><div class="sub">${total ? (100 * agentRequests / total).toFixed(1) : 0}%</div></div>
        `;
        const authKpiGrid = document.getElementById('authKpiGrid');
        if (authKpiGrid) {
          authKpiGrid.innerHTML = `
            <div class="kpi-card"><div class="label">Authenticated (1005a)</div><div class="value">${authenticated.toLocaleString()}</div><div class="sub">${total ? (100 * authenticated / total).toFixed(1) : 0}%</div></div>
            <div class="kpi-card"><div class="label">Non-authenticated</div><div class="value">${nonAuthenticated.toLocaleString()}</div><div class="sub">${total ? (100 * nonAuthenticated / total).toFixed(1) : 0}%</div></div>
          `;
        }
      }

      function sortObj(obj, limit) {
        return Object.entries(obj)
          .sort((a, b) => b[1] - a[1])
          .slice(0, limit || 999);
      }

      const colorPalette = ['#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#ec4899', '#6366f1', '#14b8a6'];

      function destroyCharts() {
        Object.values(charts).forEach(c => c && c.destroy());
        charts = {};
      }

      function renderCharts(agg) {
        destroyCharts();

        const outcomeEntries = sortObj(agg.byOutcome);
        const ctxOutcome = document.getElementById('chartOutcome').getContext('2d');
        charts.outcome = new Chart(ctxOutcome, {
          type: 'doughnut',
          data: {
            labels: outcomeEntries.map(([k]) => k),
            datasets: [{ data: outcomeEntries.map(([, v]) => v), backgroundColor: colorPalette }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        const dateEntries = Object.entries(agg.byDate).sort((a, b) => a[0].localeCompare(b[0]));
        const ctxDate = document.getElementById('chartByDate').getContext('2d');
        charts.date = new Chart(ctxDate, {
          type: 'line',
          data: {
            labels: dateEntries.map(([d]) => d),
            datasets: [{ label: 'Calls', data: dateEntries.map(([, v]) => v), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.2 }]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        const endStateColors = { finish: '#22c55e', finishXfer: '#3b82f6', bizruleXfer: '#8b5cf6' };
        OUTCOME_ENDSTATE_KEYS.forEach(outcomeKey => {
          const entries = sortObj(agg.byOutcomeAndEndState[outcomeKey] || {}, 10);
          const ctx = document.getElementById('chartEndState' + (outcomeKey === 'finish' ? 'Finish' : outcomeKey === 'finishXfer' ? 'FinishXfer' : 'BizruleXfer')).getContext('2d');
          charts['endState' + outcomeKey] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: entries.map(([k]) => k.length > 30 ? k.slice(0, 27) + '…' : k),
              datasets: [{ label: 'Calls', data: entries.map(([, v]) => v), backgroundColor: endStateColors[outcomeKey] }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } } }
          });
        });

        const intentLabels = Object.keys(agg.byIntent);
        const intentData = intentLabels.map(k => agg.byIntent[k]);
        const totalCalls = agg.total;
        const ctxIntent = document.getElementById('chartIntent').getContext('2d');
        charts.intent = new Chart(ctxIntent, {
          type: 'pie',
          data: {
            labels: intentLabels,
            datasets: [{ data: intentData, backgroundColor: colorPalette }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right' },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    const v = ctx.raw;
                    const pct = totalCalls ? (100 * v / totalCalls).toFixed(1) : 0;
                    return ctx.label + ': ' + v.toLocaleString() + ' (' + pct + '%)';
                  }
                }
              }
            }
          }
        });

        const buckets = [0, 1, 2, 3, 5, 10, 20, 999];
        const hist = buckets.slice(0, -1).map((_, i) => agg.vaDurations.filter(m => m >= buckets[i] && m < buckets[i + 1]).length);
        const labels = buckets.slice(0, -1).map((b, i) => b + '–' + (buckets[i + 1] === 999 ? '+' : buckets[i + 1]) + ' min');
        const ctxDur = document.getElementById('chartDuration').getContext('2d');
        charts.duration = new Chart(ctxDur, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'Calls', data: hist, backgroundColor: '#8b5cf6' }]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        const overlapEl = document.getElementById('overlap1047aGrid');
        if (overlapEl && agg.by1047aAndIntent) {
          overlapEl.innerHTML = INTENT_BREADCRUMBS_FOR_1047A.map(({ label }) =>
            '<div class="overlap-1047a-card"><div class="label">1047a + ' + label + '</div><div class="value">' + (agg.by1047aAndIntent[label] || 0).toLocaleString() + '</div></div>'
          ).join('');
        }

        const wismoSummaryEl = document.getElementById('wismoSummary');
        const wismoTableWrap = document.getElementById('wismoPathTableWrap');
        if (wismoSummaryEl && wismoTableWrap) {
          const entered = agg.wismoEnteredCount || 0;
          const total = agg.total || 1;
          wismoSummaryEl.innerHTML = '<div class="kpi-card"><div class="label">Calls that entered WisMO (1011c)</div><div class="value">' + entered.toLocaleString() + '</div><div class="sub">' + (total ? (100 * entered / total).toFixed(1) : 0) + '% of all calls</div></div>';
          const groupEntries = WISMO_PATH_GROUPS.map(g => ({
            name: g.name,
            codesLabel: g.codes.join(', '),
            count: agg.byWismoPathGroup[g.name] || 0
          })).filter(e => e.count > 0).sort((a, b) => b.count - a.count);
          wismoTableWrap.innerHTML = groupEntries.length
            ? '<p style="margin:0 0 0.5rem; font-size:0.85rem; color:var(--text-muted);">Paths reached within WisMO — unique calls per path (a call is counted once per path if it hit any breadcrumb in that path)</p><table class="wismo-path-table"><thead><tr><th>Path (breadcrumbs)</th><th>Calls</th></tr></thead><tbody>' +
              groupEntries.map(e => '<tr><td>' + e.name + ' (' + e.codesLabel + ')</td><td>' + e.count.toLocaleString() + '</td></tr>').join('') +
              '</tbody></table>'
            : '<p style="font-size:0.9rem; color:var(--text-muted);">No WisMO path data for this range.</p>';
        }

        const empEntries = sortObj(agg.byEmployer, 10);
        const ctxEmp = document.getElementById('chartEmployer').getContext('2d');
        charts.employer = new Chart(ctxEmp, {
          type: 'bar',
          data: {
            labels: empEntries.map(([k]) => k.length > 30 ? k.slice(0, 27) + '…' : k),
            datasets: [{ label: 'Calls', data: empEntries.map(([, v]) => v), backgroundColor: '#22c55e' }]
          },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } } }
        });
      }

      csvFile.addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;
        hideError();
        fileName.textContent = file.name;
        emptyState.querySelector('p').textContent = 'Loading…';
        emptyState.classList.add('loading');
        parseCSV(file)
          .then(rows => {
            if (!rows.length) throw new Error('CSV has no data rows.');
            allRows = rows;
            const dates = rows.map(getRowDate).filter(Boolean);
            const minDate = dates.length ? dates.reduce((a, b) => (a < b ? a : b)) : '';
            const maxDate = dates.length ? dates.reduce((a, b) => (a > b ? a : b)) : '';
            dateFrom.value = minDate;
            dateTo.value = maxDate;
            dateFrom.min = minDate;
            dateFrom.max = maxDate;
            dateTo.min = minDate;
            dateTo.max = maxDate;
            emptyState.style.display = 'none';
            dashboard.style.display = 'block';
            applyDateRange();
          })
          .catch(err => {
            emptyState.classList.remove('loading');
            emptyState.querySelector('p').textContent = 'Load a CSV file to view the dashboard.';
            showError(err.message || 'Failed to load CSV.');
          });
      });

      dateFrom.addEventListener('change', applyDateRange);
      dateTo.addEventListener('change', applyDateRange);
    })();
  </script>
</body>
</html>